<style>
    :root {
        --color-bg: #0a0b0c;
        --color-surface: #16181a;
        --color-primary: #00ff9d;
        --color-secondary: #94a3b8;
        --color-text: #ffffff;
        --color-text-dim: rgba(255, 255, 255, 0.7);
        --color-background: #1a1d23;
        --color-border: #2f343a;
    }

    .market-analysis-container {
        padding: 0;
        background-color: var(--color-bg);
        border-radius: 8px;
        color: var(--color-text);
        margin: 0;
    }

    /* Analysis Container */
    .analysis-container {
        margin-top: 20px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        padding: 15px;
        background: var(--color-surface);
        border-radius: 8px;
        border: 1px solid var(--color-border);
    }

    .indicator-analysis {
        padding: 15px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        border: 1px solid var(--color-border);
    }

    .indicator-analysis h4 {
        color: var(--color-text);
        margin: 0 0 12px 0;
        font-size: 15px;
        font-weight: 600;
    }

    .indicator-analysis .signal {
        display: inline-block;
        font-weight: bold;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 14px;
        margin-bottom: 15px;
    }

    .signal.bullish {
        background: rgba(0, 255, 0, 0.1);
        color: #00ff9d;
        border: 1px solid rgba(0, 255, 0, 0.2);
    }

    .signal.bearish {
        background: rgba(255, 0, 0, 0.1);
        color: #ff4d4d;
        border: 1px solid rgba(255, 0, 0, 0.2);
    }

    .signal.neutral {
        background: rgba(255, 255, 0, 0.1);
        color: #ffd700;
        border: 1px solid rgba(255, 255, 0, 0.2);
    }

    .indicator-analysis ul {
        margin: 15px 0;
        padding-left: 20px;
        list-style-type: none;
    }

    .indicator-analysis li {
        margin: 10px 0;
        color: var(--color-text-dim);
        font-size: 14px;
        position: relative;
        line-height: 1.4;
    }

    .indicator-analysis li:before {
        content: "-";
        position: absolute;
        left: -15px;
        color: var(--color-text-dim);
    }

    .indicator-analysis p {
        margin: 15px 0 0 0;
        font-size: 14px;
        color: var(--color-text-dim);
        line-height: 1.4;
    }

    .indicator-analysis strong {
        color: var(--color-text);
        font-weight: 600;
    }

    /* Key Levels */
    .key-levels {
        margin-top: 15px;
        padding: 15px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 8px;
        border: 1px solid var(--color-border);
    }

    .key-levels h4 {
        color: var(--color-text);
        margin: 0 0 10px 0;
        font-size: 14px;
        font-weight: 600;
    }

    .key-levels ul {
        margin: 0;
        padding-left: 20px;
        list-style-type: none;
    }

    .key-levels li {
        margin: 8px 0;
        color: var(--color-text-dim);
        font-size: 13px;
        position: relative;
    }

    .key-levels li:before {
        content: "â€¢";
        position: absolute;
        left: -15px;
        color: var(--color-secondary);
    }

    /* Top Navigation Styles */
    .top-nav {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: var(--color-surface);
        padding: 0.8rem 1.5rem;
        z-index: 1000;
        border-bottom: 1px solid var(--color-border);
    }

    .nav-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1400px;
        margin: 0 auto;
    }

    .nav-left {
        display: flex;
        align-items: center;
        gap: 2rem;
    }

    .nav-right {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .logo-container {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
        color: var(--color-text);
    }

    .nav-link {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--color-text-dim);
        text-decoration: none;
        font-size: 0.9rem;
        transition: color 0.3s;
    }

    .nav-link:hover {
        color: var(--color-primary);
    }

    .nav-link.active {
        color: var(--color-primary);
    }

    .btn-telegram {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: #229ED9;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        text-decoration: none;
        font-size: 0.9rem;
        transition: opacity 0.3s;
    }

    .btn-telegram:hover {
        opacity: 0.9;
    }

    /* Update existing styles */
    .timeframe-btn, .indicator-btn {
        background-color: var(--color-surface);
        color: var(--color-text);
        border: 1px solid var(--color-border);
        padding: 8px 16px;
        margin-right: 8px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .timeframe-btn:hover, .indicator-btn:hover {
        background-color: var(--color-primary);
        color: var(--color-bg);
    }

    .timeframe-btn.active, .indicator-btn.active {
        background-color: var(--color-primary);
        color: var(--color-bg);
        border-color: var(--color-primary);
    }

    #chartdiv {
        background-color: var(--color-surface);
    }

    .chart-container {
        background: var(--color-surface);
    }

    .analysis-panel {
        background: var(--color-surface);
    }

    .chart-controls {
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .chart-panel {
        width: 100%;
        height: 300px;
        margin-bottom: 20px;
        background: var(--color-surface);
        border-radius: 6px;
    }

    .analysis-box {
        border-left: 4px solid var(--color-primary);
        padding: 10px;
        margin-bottom: 10px;
    }

    .analysis-box h3 {
        color: var(--color-text);
        margin: 0 0 10px 0;
        font-size: 16px;
    }

    .signal {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }

    .signal-label {
        color: var(--color-text-dim);
    }

    .signal-value {
        font-weight: bold;
        font-size: 14px;
    }

    .signal-strength {
        color: var(--color-text-dim);
        font-size: 12px;
    }

    .bullish {
        color: var(--color-primary);
        border-color: var(--color-primary);
    }

    .bearish {
        color: #e74c3c;
        border-color: #e74c3c;
    }

    .neutral {
        color: #f1c40f;
        border-color: #f1c40f;
    }

    .analysis-message {
        color: var(--color-text-dim);
        font-size: 14px;
        margin: 0;
        line-height: 1.4;
    }

    .controls-panel {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
        padding: 10px;
        background: var(--color-surface);
        border-radius: 6px;
    }

    .timeframe-buttons,
    .indicator-buttons {
        display: flex;
        gap: 10px;
    }

    button {
        background: var(--color-surface);
        color: var(--color-text);
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.2s;
    }

    button:hover {
        background: var(--color-primary);
        color: var(--color-bg);
    }

    button.active {
        background: var(--color-primary);
        color: var(--color-bg);
    }
</style>

<!-- Load AmCharts -->
<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
<script src="https://cdn.amcharts.com/lib/5/stock.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Dark.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>

<!-- Add Top Navigation -->
<nav class="top-nav">
    <div class="nav-content">
        <div class="nav-left">
            <a href="../../index.html" class="logo-container">
                <img src="../../images/moose.png" alt="CryptoMoose" style="height: 32px; width: auto;">
                <span>CryptoMoose</span>
            </a>
            <a href="../../dashboard.html" class="nav-link">
                <i class="fas fa-chart-bar"></i>
                <span>Dashboard</span>
            </a>
            <a href="../../signals.html" class="nav-link">
                <i class="fas fa-signal"></i>
                <span>Signals</span>
            </a>
            <a href="new-market-analysis.html" class="nav-link active">
                <i class="fas fa-chart-line"></i>
                <span>Market Analysis</span>
            </a>
        </div>
        <div class="nav-right">
            <a href="https://t.me/cryptomoose" target="_blank" class="btn-telegram">
                <i class="fab fa-telegram"></i>
                <span>Get Live Signals</span>
            </a>
        </div>
    </div>
</nav>

<!-- Existing content starts here -->
<div id="market-analysis-section">
    <div class="market-analysis-container">
        <div class="chart-controls">
            <div class="timeframes">
                <button class="timeframe-btn active" data-timeframe="1h">1H</button>
                <button class="timeframe-btn" data-timeframe="4h">4H</button>
                <button class="timeframe-btn" data-timeframe="1d">1D</button>
            </div>
            <div class="indicators">
                <button class="indicator-btn" data-indicator="ma20">MA(20)</button>
                <button class="indicator-btn" data-indicator="ma50">MA(50)</button>
                <button class="indicator-btn" data-indicator="ma200">MA(200)</button>
                <button class="indicator-btn" data-indicator="env">MA Envelope</button>
                <button class="indicator-btn" data-indicator="zigzag">ZigZag</button>
                <button class="indicator-btn" data-indicator="median">Median Price</button>
                <button class="indicator-btn" data-indicator="typical">Typical Price</button>
                <button class="indicator-btn" data-indicator="bb">Bollinger Bands</button>
                <button class="indicator-btn" data-indicator="supertrend">SuperTrend</button>
                <button class="indicator-btn" data-indicator="ichimoku">Ichimoku</button>
                <button class="indicator-btn" data-indicator="keltner">Keltner</button>
                <button class="indicator-btn" data-indicator="psar">PSAR</button>
            </div>
        </div>
        <div id="chartdiv" style="width: 100%; height: 400px;"></div>
        <div id="analysis-container" class="analysis-container">
            <p>Enable indicators to see analysis</p>
        </div>
    </div>
</div>

<script>
    console.log('Script starting...');

    // Add license
    am5.addLicense("AM5S-5602-4210-7362-8604");
    console.log('License added');

    class BTCChart {
        constructor() {
            console.log('BTCChart constructor called');
            this.currentTimeframe = '1h';
            this.activeIndicators = new Set();
            this.root = null;
            this.chart = null;
            this.mainSeries = null;
            this.indicators = {};
        }

        async init() {
            try {
                console.log('Initializing chart...');
                
                // Create root
                console.log('Creating root element for', document.getElementById('chartdiv'));
                this.root = am5.Root.new("chartdiv");
                console.log('Root created');
                
                // Set themes
                this.root.setThemes([
                    am5themes_Dark.new(this.root),
                    am5themes_Animated.new(this.root)
                ]);
                console.log('Themes set');

                // Create chart
                this.chart = this.root.container.children.push(
                    am5xy.XYChart.new(this.root, {
                        panX: true,
                        panY: true,
                        wheelX: "panX",
                        wheelY: "zoomX",
                        layout: this.root.verticalLayout,
                        pinchZoomX: true
                    })
                );
                console.log('Chart created');

                // Create axes
                const xAxis = this.chart.xAxes.push(
                    am5xy.DateAxis.new(this.root, {
                        baseInterval: { timeUnit: "minute", count: 1 },
                        renderer: am5xy.AxisRendererX.new(this.root, {
                            minGridDistance: 50,
                            pan: "zoom"
                        })
                    })
                );
                console.log('X axis created');

                const yAxis = this.chart.yAxes.push(
                    am5xy.ValueAxis.new(this.root, {
                        renderer: am5xy.AxisRendererY.new(this.root, {
                            pan: "zoom"
                        })
                    })
                );
                console.log('Y axis created');

                // Create series
                this.mainSeries = this.chart.series.push(
                    am5xy.CandlestickSeries.new(this.root, {
                        name: "BTC/USDT",
                        xAxis: xAxis,
                        yAxis: yAxis,
                        valueYField: "Close",
                        openValueYField: "Open",
                        lowValueYField: "Low",
                        highValueYField: "High",
                        valueXField: "Date",
                        tooltip: am5.Tooltip.new(this.root, {
                            pointerOrientation: "horizontal",
                            labelText: "[bold]{name}[/]\nOpen: {openValueY}\nHigh: {highValueY}\nLow: {lowValueY}\nClose: {valueY}"
                        })
                    })
                );
                console.log('Series created');

                // Set colors
                this.mainSeries.columns.template.states.create("riseFromOpen", {
                    fill: am5.color(0x00ff00),
                    stroke: am5.color(0x00ff00)
                });

                this.mainSeries.columns.template.states.create("dropFromOpen", {
                    fill: am5.color(0xff0000),
                    stroke: am5.color(0xff0000)
                });
                console.log('Colors set');

                // Add cursor
                this.chart.set("cursor", am5xy.XYCursor.new(this.root, {
                    behavior: "none",
                    xAxis: xAxis,
                    yAxis: yAxis
                }));
                console.log('Cursor added');

                // Add scrollbar
                this.chart.set("scrollbarX", am5.Scrollbar.new(this.root, {
                    orientation: "horizontal"
                }));
                console.log('Scrollbar added');

                // Add dummy data
                const dummyData = [];
                const now = new Date();
                for (let i = 0; i < 50; i++) {
                    const time = new Date(now.getTime() - i * 60000);
                    const basePrice = 40000 + Math.random() * 1000;
                    dummyData.unshift({
                        Date: time.getTime(),
                        Open: basePrice,
                        High: basePrice + Math.random() * 100,
                        Low: basePrice - Math.random() * 100,
                        Close: basePrice + (Math.random() - 0.5) * 200
                    });
                }
                console.log('Dummy data created:', dummyData);
                this.mainSeries.data.setAll(dummyData);
                console.log('Data set to series');

                // Make stuff animate on load
                this.mainSeries.appear(1000);
                this.chart.appear(1000, 100);
                console.log('Animations started');

            } catch (error) {
                console.error('Error initializing chart:', error);
            }
        }

        setupEventListeners() {
            console.log('Setting up event listeners');
            // Timeframe buttons
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    console.log('Timeframe button clicked:', btn.dataset.timeframe);
                    document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    this.currentTimeframe = btn.dataset.timeframe;
                });
            });

            // Indicator buttons
            document.querySelectorAll('.indicator-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    console.log('Indicator button clicked:', btn.dataset.indicator);
                    const indicator = btn.dataset.indicator;
                    if (btn.classList.contains('active')) {
                        btn.classList.remove('active');
                        this.removeIndicator(indicator);
                    } else {
                        btn.classList.add('active');
                        this.addIndicator(indicator);
                    }
                });
            });
            console.log('Event listeners set up');
        }

        dispose() {
            console.log('Disposing chart');
            if (this.root) {
                this.root.dispose();
            }
        }
    }

    // Initialize chart when DOM is loaded (not window.load)
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            console.log('DOM loaded, initializing chart...');
            const chart = new BTCChart();
            await chart.init();
            chart.setupEventListeners();
            console.log('Chart initialization complete');
        } catch (error) {
            console.error('Error in main:', error);
        }
    });

    // Also try window.load as backup
    window.addEventListener('load', async () => {
        try {
            console.log('Window loaded, checking if chart exists...');
            if (!document.querySelector('#chartdiv canvas')) {
                console.log('No chart found, initializing...');
                const chart = new BTCChart();
                await chart.init();
                chart.setupEventListeners();
                console.log('Chart initialization complete');
            }
        } catch (error) {
            console.error('Error in window.load:', error);
        }
    });
</script>